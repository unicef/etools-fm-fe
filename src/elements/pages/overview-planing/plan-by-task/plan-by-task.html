<!--import [polymer/polymer-element, etools-dropdown, etools-dropdown/etools-dropdown-multi,iron-flex-layout,
            iron-icons/notification-icons]-->

<!--import [shared-styles, module-styles, tab-inputs-styles, table-styles, redux-mixin, etools-app-config, month-counter,
            route-helper-mixin, process-data-mixin, common-methods, month-counter-input]-->

<dom-module id="plan-by-task">
    <template>
        <style include="shared-styles module-styles tab-inputs-styles iron-flex table-styles iron-flex-factors iron-flex-alignment"></style>
        <!-- inject styles './plan-by-task.scss'-->

        <app-route route="{{route}}" pattern="/plan-by-task" active="{{isActive}}"></app-route>


        <paper-card>
            <div class="layout horizontal wrap">
                <div class="filter-dropdown">
                    <etools-dropdown-multi
                            selected-values="[[_simplifyValue(queryParams.cp_output_config__cp_output__parent__in)]]"
                            label="CP Outcome"
                            placeholder="Select"
                            options="[[cpOutcomes]]"
                            option-label="name"
                            option-value="id"
                            trigger-value-change-event
                            on-etools-selected-items-changed="filterValueChanged"
                            allow-outside-scroll
                            data-property="cp_output_config__cp_output__parent__in"
                            min-width="470px"
                            horizontal-align="left"
                            no-dynamic-align>
                    </etools-dropdown-multi>
                </div>
                <div class="filter-dropdown">
                    <etools-dropdown-multi
                            selected-values="[[_simplifyValue(queryParams.cp_output_config__in)]]"
                            label="[[getDescriptorLabel(permissions, 'cp_output_config.cp_output')]]"
                            placeholder="Select"
                            options="[[cpOutputConfigs]]"
                            option-label="name"
                            option-value="id"
                            trigger-value-change-event
                            on-etools-selected-items-changed="filterValueChanged"
                            allow-outside-scroll
                            data-property="cp_output_config__in"
                            min-width="450px"
                            horizontal-align="left"
                            no-dynamic-align>
                    </etools-dropdown-multi>
                </div>
                <div class="filter-dropdown">
                    <etools-dropdown-multi
                            selected-values="[[_simplifyValue(queryParams.partner__in)]]"
                            label="[[getDescriptorLabel(permissions, 'partner')]]"
                            placeholder="Select"
                            options="[[filterPartners]]"
                            option-label="name"
                            option-value="id"
                            trigger-value-change-event
                            on-etools-selected-items-changed="filterValueChanged"
                            allow-outside-scroll
                            data-property="partner__in"
                            min-width="400px"
                            horizontal-align="left"
                            no-dynamic-align>
                    </etools-dropdown-multi>
                </div>
                <div class="filter-dropdown">
                    <etools-dropdown-multi
                            selected-values="[[_simplifyValue(queryParams.location__in)]]"
                            label="[[getDescriptorLabel(permissions, 'location')]]"
                            placeholder="Select"
                            options="[[filterLocations]]"
                            option-label="name"
                            option-value="id"
                            trigger-value-change-event
                            on-etools-selected-items-changed="filterValueChanged"
                            allow-outside-scroll
                            data-property="location__in"
                            min-width="400px"
                            horizontal-align="left"
                            no-dynamic-align>
                    </etools-dropdown-multi>
                </div>
                <div class="filter-dropdown">
                    <etools-dropdown-multi
                            selected-values="[[_simplifyValue(queryParams.location_site__in)]]"
                            label="[[getDescriptorLabel(permissions, 'location_site')]]"
                            placeholder="Select"
                            options="[[filterSites]]"
                            option-label="name"
                            option-value="id"
                            trigger-value-change-event
                            on-etools-selected-items-changed="filterValueChanged"
                            allow-outside-scroll
                            data-property="location_site__in"
                            horizontal-align="left"
                            no-dynamic-align>
                    </etools-dropdown-multi>
                </div>
                <div class="toggle-button-control">
                    <paper-toggle-button
                            checked="[[queryParams.cp_output_config__is_priority]]"
                            on-checked-changed="filterValueChanged"
                            data-property="cp_output_config__is_priority"></paper-toggle-button>
                    <span>Show Priority Only</span>
                </div>
            </div>
        </paper-card>


        <paper-card class="table-container">

            <div class="table-title-block with-bottom-line">
                <div class="table-title">[[visibleRange.0]] - [[visibleRange.1]] of [[count]] monitoring tasks to show</div>
            </div>

            <etools-data-table-header id="listHeader"
                                      no-collapse no-title>
                <etools-data-table-column class="flex-4" field="cp_output_config__cp_output__name" sortable>
                    [[getDescriptorLabel(permissions, 'cp_output_config.cp_output')]] (Priority <iron-icon icon="notification:priority-high"></iron-icon>)
                </etools-data-table-column>
                <etools-data-table-column class="flex-4" field="partner__name,intervention__title" sortable>
                    [[getDescriptorLabel(permissions, 'partner')]] & [[getDescriptorLabel(permissions, 'intervention')]]
                </etools-data-table-column>
                <etools-data-table-column class="flex-5" field="location__name,location_site__name" sortable>
                    [[getDescriptorLabel(permissions, 'location')]] & [[getDescriptorLabel(permissions, 'location_site')]]
                </etools-data-table-column>
                <etools-data-table-column class="w300px" field="plan">
                    [[getDescriptorLabel(permissions, 'plan_by_month')]]
                </etools-data-table-column>
            </etools-data-table-header>

            <template is="dom-repeat" items="[[planingTasks]]">
                <etools-data-table-row no-collapse secondary-bg-on-hover>
                    <div slot="row-data" class="layout horizontal editable-row">

                        <div class="col-data flex-4 truncated">
                            <iron-icon icon="notification:priority-high" hidden$="[[!item.cp_output_config.is_priority]]"></iron-icon>[[item.cp_output_config.cp_output.name]]
                        </div>
                        <div class="col-data flex-4 layout vertical start center-justified truncated">
                            <a href$="[[item.partner.url]]" target="_blank">[[item.partner.name]]</a>
                            <a href$="[[item.intervention.url]]" target="_blank">[[item.intervention.title]]</a>
                        </div>
                        <div class="col-data flex-5 truncated">
                            <b>[[getLocationPart(item.location.name, 'name')]]</b>
                            <span class="location-code">[[[getLocationPart(item.location.name, 'code')]]]</span>
                            <i>[[item.location_site.name]]</i>
                        </div>
                        <div class="col-data w300px"><month-counter count="[[item.plan_by_month]]"></month-counter></div>

                        <div class="hover-block">
                            <iron-icon icon="icons:content-copy" on-tap="openDialog" data-type="copy"></iron-icon>
                            <iron-icon icon="icons:create" on-tap="openDialog" data-type="edit"></iron-icon>
                            <iron-icon icon="icons:delete" on-tap="openDialog" data-type="remove"></iron-icon>
                        </div>

                    </div>
                </etools-data-table-row>

            </template>

            <template is="dom-if" if="[[!planingTasks.length]]">
                <etools-data-table-row no-collapse>
                    <div slot="row-data" class="layout horizontal">
                        <div class="col-data flex-1">-</div>
                        <div class="col-data flex-1">-</div>
                        <div class="col-data flex-1">-</div>
                        <div class="col-data w300px">-</div>
                    </div>
                </etools-data-table-row>
            </template>

            <etools-data-table-footer
                    page-size="[[queryParams.page_size]]"
                    page-number="[[queryParams.page]]"
                    total-results="[[count]]"
                    visible-range="{{visibleRange}}"
                    on-page-size-changed="pageSizeSelected"
                    on-page-number-changed="pageNumberChanged">
            </etools-data-table-footer>
        </paper-card>

        <etools-dialog
                size="md"
                id="dialog"
                theme="[[dialog.theme]]"
                no-padding
                opened="{{dialog.opened}}"
                dialog-title="[[dialog.title]]"
                keep-dialog-open
                on-confirm-btn-clicked="saveTask"
                on-iron-overlay-closed="resetData"
                ok-btn-text="[[dialog.confirm]]">
            <etools-loading
                    active="[[savingInProcess]]"
                    loading-text="Saving Data">
            </etools-loading>

            <template is="dom-if" if="[[notTouched]]">
                <div class="copy-warning">It is required to change at least one of the fields below.</div>
            </template>

            <template is="dom-if" if="[[checkDialogType(dialog.type, 'remove')]]">
                <div class="remove-title">Are you sure that you want to delete this task?</div>
            </template>

            <template is="dom-if" if="[[checkDialogType(dialog.type, 'edit')]]">
                <div class="edited-info">
                    <div class="title">You have selected</div>
                    <div class="line layout start horizontal">
                        <div class="title">[[getDescriptorLabel(permissions, 'cp_output_config.cp_output')]]</div> <div class="value">[[originalData.cp_output_config.cp_output.name]]</div>
                    </div>
                    <div class="line layout start horizontal">
                        <div class="title">[[getDescriptorLabel(permissions, 'partner')]]</div> <div class="value">[[originalData.partner.name]]</div>
                    </div>
                    <div class="line layout start horizontal" hidden$="[[!originalData.intervention]]">
                        <div class="title">[[getDescriptorLabel(permissions, 'intervention')]]</div> <div class="value">[[originalData.intervention.title]]</div>
                    </div>
                </div>
            </template>

            <template is="dom-if" if="[[!checkDialogType(dialog.type, 'remove')]]">
                <div hidden$="[[checkDialogType(dialog.type, 'edit')]]">
                    <div class="container first layout horizontal">
                        <etools-dropdown
                                class="validate-input disabled-as-readonly flex-3"
                                selected="[[_simplifyValue(editedItem.cp_output_config)]]"
                                selected-item="{{selectedOutput}}"
                                label="[[getDescriptorLabel(permissions, 'cp_output_config')]]"
                                placeholder="[[getPlaceholder(permissions, 'cp_output_config', 'Select')]]"
                                options="[[cpOutputConfigs]]"
                                option-label="name"
                                option-value="id"
                                required$="[[getRequiredStatus(permissions, 'cp_output_config')]]"
                                disabled$="[[getReadonlyStatus(permissions, 'cp_output_config')]]"
                                readonly$="[[getReadonlyStatus(permissions, 'cp_output_config')]]"
                                invalid="{{errors.cp_output_config}}"
                                error-message="{{errors.cp_output_config}}"
                                on-focus="resetFieldError"
                                on-tap="resetFieldError"
                                on-etools-selected-item-changed="setEditedValue"
                                data-fieldname="cp_output_config"
                                trigger-value-change-event allow-outside-scroll dynamic-align></etools-dropdown>
                    </div>

                    <div class="container layout horizontal">
                        <etools-dropdown
                                class="validate-input disabled-as-readonly flex-3"
                                selected="[[_simplifyValue(editedItem.partner)]]"
                                label="[[getDescriptorLabel(permissions, 'partner')]]"
                                placeholder="[[getPlaceholder(permissions, 'partner', 'Select')]]"
                                options="[[selectedOutput.partners]]"
                                option-label="name"
                                option-value="id"
                                required$="[[getRequiredStatus(permissions, 'partner')]]"
                                disabled$="[[isReadonlyField(permissions, 'partner', editedItem.cp_output_config)]]"
                                readonly$="[[isReadonlyField(permissions, 'partner', editedItem.cp_output_config)]]"
                                invalid="{{errors.partner}}"
                                error-message="{{errors.partner}}"
                                on-focus="resetFieldError"
                                on-tap="resetFieldError"
                                on-etools-selected-item-changed="setEditedValue"
                                data-fieldname="partner"
                                trigger-value-change-event allow-outside-scroll
                                dynamic-align></etools-dropdown>
                    </div>

                    <div class="container layout horizontal">
                        <etools-dropdown
                                class="validate-input disabled-as-readonly flex-3"
                                selected="[[_simplifyValue(editedItem.intervention)]]"
                                label="[[getDescriptorLabel(permissions, 'intervention')]]"
                                placeholder="[[getPlaceholder(permissions, 'intervention', 'Select')]]"
                                options="[[interventionsList]]"
                                option-label="title"
                                option-value="id"
                                required$="[[getRequiredStatus(permissions, 'intervention')]]"
                                disabled$="[[isReadonlyField(permissions, 'intervention', editedItem.partner)]]"
                                readonly$="[[isReadonlyField(permissions, 'intervention', editedItem.partner)]]"
                                invalid="{{errors.intervention}}"
                                error-message="{{errors.intervention}}"
                                on-focus="resetFieldError"
                                on-tap="resetFieldError"
                                on-etools-selected-item-changed="setEditedValue"
                                data-fieldname="intervention"
                                trigger-value-change-event allow-outside-scroll
                                dynamic-align></etools-dropdown>
                    </div>

                    <div class="container layout horizontal">
                        <etools-dropdown
                                class="validate-input disabled-as-readonly flex-3"
                                selected="[[_simplifyValue(editedItem.location)]]"
                                selected-item="{{selectedLocation}}"
                                label="[[getDescriptorLabel(permissions, 'location')]]"
                                placeholder="[[getPlaceholder(permissions, 'location', 'Select')]]"
                                options="[[locations]]"
                                option-label="name"
                                option-value="id"
                                required$="[[getRequiredStatus(permissions, 'location')]]"
                                disabled$="[[getReadonlyStatus(permissions, 'location')]]"
                                readonly$="[[getReadonlyStatus(permissions, 'location')]]"
                                invalid="{{errors.location}}"
                                error-message="{{errors.location}}"
                                on-focus="resetFieldError"
                                on-tap="resetFieldError"
                                on-etools-selected-item-changed="setEditedValue"
                                data-fieldname="location"
                                trigger-value-change-event allow-outside-scroll
                                dynamic-align></etools-dropdown>

                        <etools-dropdown
                                class="validate-input disabled-as-readonly flex-3"
                                selected="[[_simplifyValue(editedItem.location_site)]]"
                                label="[[getDescriptorLabel(permissions, 'location_site')]]"
                                placeholder="[[getPlaceholder(permissions, 'location_site', 'Select')]]"
                                options="[[selectedLocation.sites]]"
                                option-label="name"
                                option-value="id"
                                required$="[[getRequiredStatus(permissions, 'location_site')]]"
                                disabled$="[[isReadonlyField(permissions, 'location_site', editedItem.location)]]"
                                readonly$="[[isReadonlyField(permissions, 'location_site', editedItem.location)]]"
                                invalid="{{errors.location_site}}"
                                error-message="{{errors.location_site}}"
                                on-focus="resetFieldError"
                                on-tap="resetFieldError"
                                on-etools-selected-item-changed="setEditedValue"
                                data-fieldname="location_site"
                                trigger-value-change-event allow-outside-scroll
                                dynamic-align></etools-dropdown>
                    </div>
                </div>


                <div class="container block layout horizontal" is-edit-dialog$="[[checkDialogType(dialog.type, 'edit')]]">

                    <div class="field-title layout center horizontal">
                        Plan numbers of tasks per month in the selected Location/Site
                    </div>

                    <div class="location-and-counter layout horizontal center">

                        <div class="layout start vertical flex-auto" hidden$="[[!checkDialogType(dialog.type, 'edit')]]">
                            <div class="layout start horizontal">
                                <b>[[getLocationPart(originalData.location.name, 'name')]]</b>
                                <span class="location-code">[[[getLocationPart(originalData.location.name, 'code')]]]</span>
                            </div>
                            <i>[[originalData.location_site.name]]</i>
                        </div>

                        <month-counter-input count="{{editedItem.plan_by_month}}"></month-counter-input>
                    </div>

                </div>


                <div class="container selected-partners-tasks" hidden$="[[!partnerTasks.length]]">
                    <div class="planned-tasks-text">Planned tasks for the selected Partner and PD/SSFA</div>
                    <template is="dom-repeat" items="[[partnerTasks]]">
                        <div class="layout horizontal">
                            <div class="layout start vertical flex-auto">
                                <div class="layout start horizontal">
                                    <b>[[getLocationPart(item.location.name, 'name')]]</b>
                                    <span class="location-code">[[[getLocationPart(item.location.name, 'code')]]]</span>
                                </div>
                                <i>[[item.location_site.name]]</i>
                            </div>
                            <month-counter-input count="[[item.plan_by_month]]" readonly></month-counter-input>
                        </div>
                    </template>
                </div>
            </template>

        </etools-dialog>

    </template>

    <!-- inject scripts './plan-by-task.ts'-->
</dom-module>

<!--import [polymer/polymer-element, etools-dropdown, etools-dropdown/etools-dropdown-multi, iron-flex-layout,
            iron-icons/notification-icons]-->

<!--import [shared-styles, module-styles, tab-inputs-styles, table-styles, redux-mixin, etools-app-config, month-counter,
            route-helper-mixin, process-data-mixin, common-methods, month-counter-input]-->

<dom-module id="plan-by-task">
    <template>
        <style include="shared-styles module-styles tab-inputs-styles iron-flex table-styles iron-flex-factors iron-flex-alignment"></style>
        <!-- inject styles './plan-by-task.scss'-->

        <app-route route="{{route}}" pattern="/plan-by-task" active="{{isActive}}"></app-route>


        <paper-card class="layout horizontal center">
            <div class="layout horizontal wrap flex-auto">
                <div class="filter-dropdown">
                    <etools-dropdown class="year-dropdown"
                                     selected="{{selectedYear}}"
                                     label="Year"
                                     placeholder$="Select Year"
                                     options="[[yearOptions]]"
                                     option-label="label"
                                     option-value="value"
                                     trigger-value-change-event
                                     on-etools-selected-item-changed="onYearSelected"
                                     hide-search allow-outside-scroll></etools-dropdown>
                </div>
                <div class="toggle-button-control">
                    <paper-toggle-button
                            checked="[[queryParams.cp_output_config__is_priority]]"
                            on-checked-changed="filterValueChanged"
                            data-property="cp_output_config__is_priority"></paper-toggle-button>
                    <span>Show Priority Only</span>
                </div>
                <template is="dom-repeat" items="[[listFilterOptions]]">
                    <div class="filter-dropdown" hidden$="[[!item.selected]]">
                        <etools-dropdown-multi
                                selected-values="[[simplifyValue(item.query)]]"
                                label="[[item.name]]"
                                placeholder="Select"
                                options="[[getOptions(item.optionsKey, cpOutcomes, cpOutputConfigs, filterPartners, filterLocations, filterSites, sections)]]"
                                option-label="[[item.label]]"
                                option-value="[[item.value]]"
                                trigger-value-change-event
                                on-etools-selected-items-changed="filterValueChanged"
                                allow-outside-scroll
                                data-property$="[[item.query]]"
                                data-options-key$="[[item.optionsKey]]"
                                min-width$="[[item.minWidth]]"
                                horizontal-align="left"
                                no-dynamic-align>
                        </etools-dropdown-multi>
                    </div>

                </template>
            </div>
            <div class="fixed-controls layout horizontal center-center">
                <div class="divider"></div>
                <paper-menu-button id="filterMenu" ignore-select horizontal-align="right">
                    <paper-button class="button" slot="dropdown-trigger">
                        <iron-icon icon="filter-list"></iron-icon>
                        Filters
                    </paper-button>
                    <paper-listbox slot="dropdown-content" multi>
                        <template is="dom-repeat" items="[[listFilterOptions]]">
                            <paper-icon-item on-tap="onFilterSelect" selected$="[[item.selected]]">
                                <iron-icon icon="check" slot="item-icon" hidden$="[[!item.selected]]"></iron-icon>
                                <paper-item-body>[[item.name]]</paper-item-body>
                            </paper-icon-item>
                        </template>
                    </paper-listbox>
                </paper-menu-button>
            </div>
        </paper-card>

        <div class="layout horizontal toggle-button-control end-justified toggle-button-control">
            <paper-toggle-button
                    checked="[[value]]"
                    on-checked-changed="showCompletedChanged"></paper-toggle-button>
            <span>Show Completed</span>
        </div>

        <paper-card class="table-container">
            <div class="table-title-block with-bottom-line">
                <div class="year-info horizontal layout flex-auto">
                    <div class="text print-text layout horizontal flex-auto">
                        total planned: <span class="amount">[[yearPlan.total_planned.tasks]]</span>
                        task[[getPlural(yearPlan.total_planned.tasks)]] covering <span class="amount">[[yearPlan.total_planned.cp_outputs]]</span>
                        output[[getPlural(yearPlan.total_planned.cp_outputs)]] in <span class="amount">[[yearPlan.total_planned.sites]]</span>
                        site[[getPlural(yearPlan.total_planned.sites)]]
                    </div>
                    <div class="text print-text">Total by Month:</div>
                    <div class="layout horizontal end month-counter">
                        <month-counter show-titles count="[[yearPlan.tasks_by_month]]"></month-counter>
                        <div class="total-count">[[calcCompleted(yearPlan.tasks_by_month)]]</div>
                    </div>
                </div>
            </div>

            <etools-data-table-header id="listHeader"
                                      no-collapse no-title>
                <etools-data-table-column class="flex-4" field="cp_output_config__cp_output__name" sortable>
                    <!--[[getDescriptorLabel(permissions, 'cp_output_config.cp_output')]] (Priority <iron-icon icon="notification:priority-high"></iron-icon>)-->
                    CP Output To Be Monitored (Priority <iron-icon icon="notification:priority-high"></iron-icon>)
                </etools-data-table-column>
                <etools-data-table-column class="flex-4" field="partner__name,intervention__title" sortable>
                    <!--[[getDescriptorLabel(permissions, 'partner')]] & [[getDescriptorLabel(permissions, 'intervention')]]-->
                    Partner & PD/SSFA Covered
                </etools-data-table-column>
                <etools-data-table-column class="flex-5" field="location__name,location_site__name" sortable>
                    <!--[[getDescriptorLabel(permissions, 'location')]] & [[getDescriptorLabel(permissions, 'location_site')]]-->
                    Location & Site
                </etools-data-table-column>
                <etools-data-table-column class="w330px" field="plan">
                    <div class="tasks-per-month-title">
                        Planned <div>#</div>, Completed <div class="completed">#</div> Number of Tasks Per Month
                    </div>
                </etools-data-table-column>
            </etools-data-table-header>

            <template is="dom-repeat" items="[[planingTasks]]">
                <etools-data-table-row no-collapse secondary-bg-on-hover>
                    <div slot="row-data" class="layout horizontal editable-row">

                        <div class="col-data flex-4">
                            <div class="truncate">
                                <iron-icon icon="notification:priority-high" hidden$="[[!item.cp_output_config.is_priority]]"></iron-icon>[[item.cp_output_config.cp_output.name]]
                            </div>
                        </div>

                        <div class="col-data flex-4 layout vertical start center-justified">
                            <div class="truncate">
                                <a href$="[[item.partner.url]]" target="_blank">[[item.partner.name]]</a><br>
                                <a href$="[[item.intervention.url]]" target="_blank">[[item.intervention.title]]</a>
                            </div>
                        </div>

                        <div class="col-data flex-5">
                            <div class="truncate">
                                <b>[[getLocationPart(item.location.name, 'name')]]</b>
                                <span class="location-code">[[getLocationPart(item.location.name, 'code')]]</span>
                                <i>[[item.location_site.name]]</i>
                            </div>
                        </div>

                        <div class="col-data w330px">
                            <div class$="layout vertical">
                                <div class="layout horizontal month-counter">
                                    <month-counter count="[[item.plan_by_month]]"></month-counter>
                                    <div class="total-count">[[calcCompleted(item.plan_by_month)]]</div>
                                </div>
                                <template is="dom-if" if="[[showCompleted]]">
                                    <div class="layout horizontal month-counter">
                                        <month-counter count="[[item.plan_by_month]]"></month-counter>
                                        <div class="total-count">[[calcCompleted(item.plan_by_month)]]</div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div class="hover-block"  hidden$="[[isReadonlyCollection(permissions)]]">
                            <iron-icon icon="icons:content-copy" on-tap="openDialog" data-type="copy"></iron-icon>
                            <iron-icon icon="icons:create" on-tap="openDialog" data-type="edit"></iron-icon>
                            <iron-icon icon="icons:delete" on-tap="openDialog" data-type="remove"></iron-icon>
                        </div>

                    </div>
                </etools-data-table-row>

            </template>

            <template is="dom-if" if="[[!planingTasks.length]]">
                <etools-data-table-row no-collapse>
                    <div slot="row-data" class="layout horizontal">
                        <div class="col-data flex-1">-</div>
                        <div class="col-data flex-1">-</div>
                        <div class="col-data flex-1">-</div>
                        <div class="col-data w300px">-</div>
                    </div>
                </etools-data-table-row>
            </template>

            <etools-data-table-footer
                    page-size="[[queryParams.page_size]]"
                    page-number="[[queryParams.page]]"
                    total-results="[[count]]"
                    visible-range="{{visibleRange}}"
                    on-page-size-changed="pageSizeSelected"
                    on-page-number-changed="pageNumberChanged">
            </etools-data-table-footer>
        </paper-card>

        <etools-dialog
                size="md"
                id="dialog"
                theme="[[dialog.theme]]"
                no-padding
                opened="{{dialog.opened}}"
                dialog-title="[[dialog.title]]"
                keep-dialog-open
                on-confirm-btn-clicked="saveTask"
                on-iron-overlay-closed="resetData"
                ok-btn-text="[[dialog.confirm]]">
            <etools-loading
                    active="[[savingInProcess]]"
                    loading-text="Saving Data">
            </etools-loading>

            <template is="dom-if" if="[[checkDialogType(dialog.type, 'remove')]]">
                <div class="remove-title">Are you sure that you want to delete this task?</div>
            </template>

            <template is="dom-if" if="[[!checkDialogType(dialog.type, 'remove')]]">
                <div class="container first layout horizontal">
                    <etools-dropdown
                            class="validate-input disabled-as-readonly flex-3"
                            selected="[[_simplifyValue(selectedModel.cp_output_config)]]"
                            selected-item="{{selectedOutput}}"
                            label="[[getDescriptorLabel(permissions, 'cp_output_config.cp_output')]]"
                            placeholder="[[getPlaceholder(permissions, 'cp_output_config.cp_output', 'Select')]]"
                            options="[[cpOutputConfigs]]"
                            option-label="name"
                            option-value="id"
                            required$="[[getRequiredStatus(permissions, 'cp_output_config')]]"
                            disabled$="[[isReadonlyField(permissions, 'cp_output_config', 1, dialog.type)]]"
                            readonly$="[[isReadonlyField(permissions, 'cp_output_config', 1, dialog.type)]]"
                            invalid="{{errors.cp_output_config}}"
                            error-message="{{errors.cp_output_config}}"
                            on-focus="resetFieldError"
                            on-tap="resetFieldError"
                            on-etools-selected-item-changed="setEditedValue"
                            data-fieldname="cp_output_config"
                            trigger-value-change-event allow-outside-scroll dynamic-align></etools-dropdown>
                </div>

                <div class="container layout horizontal">
                    <etools-dropdown-multi
                            class="validate-input disabled-as-readonly flex"
                            label="[[getDescriptorLabel(permissions, 'sections')]]"
                            placeholder="[[getPlaceholder(permissions, 'sections', 'Select')]]"
                            selected-values="[[_simplifyValue(selectedModel.sections)]]"
                            options="[[sections]]"
                            option-value="id"
                            option-label="name"
                            required$="[[getRequiredStatus(permissions, 'sections')]]"
                            disabled$="[[isReadonlyField(permissions, 'sections', sections, dialog.type)]]"
                            readonly$="[[isReadonlyField(permissions, 'sections', sections, dialog.type)]]"
                            invalid="{{errors.sections}}"
                            error-message="{{errors.sections}}"
                            on-focus="resetFieldError"
                            on-tap="resetFieldError"
                            trigger-value-change-event
                            data-fieldname="sections"
                            on-etools-selected-items-changed="setSelections"
                            allow-outside-scroll
                            no-dynamic-align>
                    </etools-dropdown-multi>
                </div>

                <div class="container layout horizontal">
                    <etools-dropdown
                            class="validate-input disabled-as-readonly flex-3"
                            selected="[[_simplifyValue(selectedModel.partner)]]"
                            label="[[getDescriptorLabel(permissions, 'partner')]]"
                            placeholder="[[getPlaceholder(permissions, 'partner', 'Select')]]"
                            options="[[selectedOutput.partners]]"
                            option-label="name"
                            option-value="id"
                            required$="[[getRequiredStatus(permissions, 'partner')]]"
                            disabled$="[[isReadonlyField(permissions, 'partner', selectedModel.cp_output_config, dialog.type)]]"
                            readonly$="[[isReadonlyField(permissions, 'partner', selectedModel.cp_output_config, dialog.type)]]"
                            invalid="{{errors.partner}}"
                            error-message="{{errors.partner}}"
                            on-focus="resetFieldError"
                            on-tap="resetFieldError"
                            on-etools-selected-item-changed="setEditedValue"
                            data-fieldname="partner"
                            trigger-value-change-event allow-outside-scroll
                            dynamic-align></etools-dropdown>
                </div>

                <div class="container layout horizontal" hidden$="[[isGovernment(selectedModel.partner)]]">
                    <etools-dropdown
                            class="validate-input disabled-as-readonly flex-3"
                            selected="[[_simplifyValue(selectedModel.intervention)]]"
                            label="[[getDescriptorLabel(permissions, 'intervention')]]"
                            placeholder="[[getPlaceholder(permissions, 'intervention', 'Select')]]"
                            options="[[interventionsList]]"
                            option-label="title"
                            option-value="id"
                            required$="[[isInterventionRequired(permissions, 'intervention', selectedModel.partner)]]"
                            disabled$="[[isReadonlyField(permissions, 'intervention', selectedModel.partner, dialog.type)]]"
                            readonly$="[[isReadonlyField(permissions, 'intervention', selectedModel.partner, dialog.type)]]"
                            invalid="{{errors.intervention}}"
                            error-message="{{errors.intervention}}"
                            on-focus="resetFieldError"
                            on-tap="resetFieldError"
                            on-etools-selected-item-changed="setEditedValue"
                            data-fieldname="intervention"
                            trigger-value-change-event allow-outside-scroll
                            dynamic-align></etools-dropdown>
                </div>

                <div class="container layout horizontal">
                    <etools-dropdown
                            class="validate-input disabled-as-readonly flex-3"
                            selected="[[_simplifyValue(selectedModel.location)]]"
                            label="[[getDescriptorLabel(permissions, 'location')]]"
                            placeholder="[[getPlaceholder(permissions, 'location', 'Select')]]"
                            options="[[locationsList]]"
                            option-label="name"
                            option-value="id"
                            required$="[[getRequiredStatus(permissions, 'location')]]"
                            disabled$="[[isReadonlyField(permissions, 'location', enableLocationSelect, dialog.type)]]"
                            readonly$="[[isReadonlyField(permissions, 'location', enableLocationSelect, dialog.type)]]"
                            invalid="{{errors.location}}"
                            error-message="{{errors.location}}"
                            on-focus="resetFieldError"
                            on-tap="resetFieldError"
                            on-etools-selected-item-changed="setEditedValue"
                            data-fieldname="location"
                            trigger-value-change-event allow-outside-scroll
                            dynamic-align></etools-dropdown>

                    <etools-dropdown
                            class="validate-input disabled-as-readonly flex-3"
                            selected="[[_simplifyValue(selectedModel.location_site)]]"
                            label="[[getDescriptorLabel(permissions, 'location_site')]]"
                            placeholder="[[getPlaceholder(permissions, 'location_site', 'Select')]]"
                            options="[[selectedLocation.sites]]"
                            option-label="name"
                            option-value="id"
                            required$="[[getRequiredStatus(permissions, 'location_site')]]"
                            disabled$="[[isReadonlyField(permissions, 'location_site', selectedLocation, dialog.type)]]"
                            readonly$="[[isReadonlyField(permissions, 'location_site', selectedLocation, dialog.type)]]"
                            invalid="{{errors.location_site}}"
                            error-message="{{errors.location_site}}"
                            on-focus="resetFieldError"
                            on-tap="resetFieldError"
                            on-etools-selected-item-changed="setEditedValue"
                            data-fieldname="location_site"
                            trigger-value-change-event allow-outside-scroll
                            dynamic-align></etools-dropdown>
                </div>


                <div class="container block layout horizontal">

                    <div class="field-title layout center horizontal">
                        Plan numbers of tasks per month in the selected Location/Site
                    </div>

                    <div class="location-and-counter layout horizontal center">
                        <month-counter-input count="{{selectedModel.plan_by_month}}" year="[[selectedYear]]" test="test"></month-counter-input>
                    </div>

                </div>


                <div class="container selected-partners-tasks" hidden$="[[!partnerTasks.length]]">
                    <div class="planned-tasks-text">Planned tasks for the selected Partner and PD/SSFA</div>
                    <template is="dom-repeat" items="[[partnerTasks]]">
                        <div class="layout horizontal center" data-type="">
                            <iron-icon class="link-icon" icon="launch" data-type="edit" on-tap="reopenDialog"></iron-icon>
                            <div class="layout start vertical flex-auto">
                                <div class="layout start horizontal">
                                    <b>[[getLocationPart(item.location.name, 'name')]]</b>
                                    <span class="location-code">[[getLocationPart(item.location.name, 'code')]]</span>
                                </div>
                                <i>[[item.location_site.name]]</i>
                            </div>
                            <month-counter-input count="[[item.plan_by_month]]" readonly></month-counter-input>
                        </div>
                    </template>
                </div>
            </template>

        </etools-dialog>

    </template>

    <!-- inject scripts './plan-by-task.ts'-->
</dom-module>
